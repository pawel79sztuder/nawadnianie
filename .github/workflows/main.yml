name: Build ESP32 Project

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
      # Dodaj folder z arduino-cli do PATH na kolejne kroki
    - name: Add Arduino CLI to PATH
      run: echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

    - name: Check Arduino CLI version
      run: arduino-cli version

    - name: Setup Arduino ESP32 platform
      run: |
        arduino-cli core update-index
        arduino-cli core install esp32:esp32 --version 3.3.0
        arduino-cli core list

    - name: Fix ESPAsyncWiFiManager library folder structure
      run: |
        for lib in $GITHUB_WORKSPACE/esp32_lcd_g4_s2_www_ok/libraries/*; do
          if [ -d "$lib" ]; then
            mkdir -p "$lib/src"
            mv "$lib"/*.h "$lib/src/" 2>/dev/null || true
            mv "$lib"/*.cpp "$lib/src/" 2>/dev/null || true
          fi
        done

    - name: Compile sketch
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32doit-devkit-v1 \
          --libraries $GITHUB_WORKSPACE/esp32_lcd_g4_s2_www_ok/libraries \
          $GITHUB_WORKSPACE/esp32_lcd_g4_s2_www_ok/esp32_lcd_g4_s2_www_ok.ino \
          --verbose
